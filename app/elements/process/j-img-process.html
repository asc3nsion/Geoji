<!-- 
This is an element for image processing using caman js.
-->
<!-- components: -->
<link rel="import" href="/bower_components/polymer/polymer.html">
<!-- behaviors: -->
<link rel="import" href="../../behaviors/style/j-styles.html">
<link rel="import" href="../../behaviors/interaction/j-handler.html">
<link rel="import" href="../../behaviors/selection/auto-id.html">	

<script src="../../bower_components/caman/dist/caman.min.js"></script>
<script src="../../bower_components/Croppie/croppie.min.js"></script>

<dom-module id= "j-img-process">
	<template>
		<div id="{{assignCtrl('main')}}">
			<imgur-upload id="j-" file="{{file}}" client-id="c16e7a9d7583546" auto="true"></imgur-upload>
			<canvas id="j-process-canvas" width="200px" height="200px"></canvas>
			<img id="j-process-img">
			<input id="j-process-input" type="file">
			<paper-button on-tap="loadImg">Load</paper-button>
		</div>
	</template>
</dom-module>

<script>
	Polymer({		
		is: "j-img-process",
		properties: {
			url:{
				type: String,
				value:""
			},
			file: {
				type: Object
			}
		},

		behaviors:[InteractionBehaviors.JHandler, InteractionBehaviors.JEvents, SelectionBehaviors.AutoId],

		ready: function(){

		},
		attached: function(){
			var e = document.querySelector("#j-process-input");
			var i = document.querySelector("#j-process-img");
			var self = this;

			e.addEventListener('change', function() {
            	//p.file = this.files[0];
	            console.log(this.files[0]);
	            self.cropImage(this.files[0], 200, 200);
	        });

	        i.addEventListener('load', function() {
            	//p.file = this.files[0];
            	console.log("img loaded");
            	console.log(this);
            	var file = self.dataURItoBlob(this.src);
            	var fd = new FormData(i);
            	console.log(fd);
            	self.file = file;
            	//self.croppieProcess();
	        });

		},
		cropImage: function(file, w, h){
			console.log("crop image");
			imageType = /image.*/;

	        if (!file.type.match(imageType)){
	        	console.log("Not a valid image type!");
	        }else{
	        	var reader = new FileReader();
		        reader.onload = this.fileOnLoad;
		        reader.readAsDataURL(file);
	        }

		},
		fileOnLoad: function(e){
			console.log("file on load");
			
			var c = document.querySelector("#j-process-canvas");
			var i = document.querySelector("#j-process-img");
			var self = this;

			
			var caman = Caman("#j-process-img", function () {
			  this.resize({
			    width: 100,
			    height: 100
			  });
			  this.callback = self.camanCallback;
			  // You still have to call render!
			  this.render();
			  
			});

			
			//i.src = caman.canvas.toDataURL("image/jpg")

	        // var context = c.getContext('2d');


	        // // //$img.load(function() {
	        //      context.drawImage(this, 0, 0);
	        // //});
		},
		camanCallback: function(){
			console.log(this);
		},
		loadImg: function(){
			this.fireJMouseEvent(this.ctrls.imgInput, "click");
		},
		dataURItoBlob: function(dataURI) {
		    // convert base64/URLEncoded data component to raw binary data held in a string
		     var binary = atob(dataURI.split(',')[1]);
		    var array = [];
		    for(var i = 0; i < binary.length; i++) {
		        array.push(binary.charCodeAt(i));
		    }
		    return new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
		},
		croppieProcess: function(){
			var i = document.getElementById('j-process-img');
			var c = new Croppie(document.getElementById('j-process-img'), {
			    viewport: {
			        width: 100,
			        height: 100,
			        type: 'circle' //default 'square'
			    },
			    boundary: {
			        width: 50,
			        height: 50
			    },
			    customClass: '',
			    enableZoom: false, //default true // previously showZoom
			    showZoomer: false, //default true
			    mouseWheelZoom: false, //default true
			    update: function (cropper) { }
			});
			// bind an image to croppie
			c.bind({
			    url: 'path/to/image',
			    points: [50, 50, 150, 150]
			});
			// set the zoom programatically. Restricted to the min/max values of the slider
			c.setZoom(1.5);
			// get crop points from croppie
			var data = c.get();
			// get result from croppie
			// returns Promise
			var result = c.result('html|canvas').then(function (img) {
				console.log(img);
				i.src = img;
			    //img is html positioning & sizing the image correctly if resultType is 'html'
			    //img is base64 url of cropped image if resultType is 'canvas' 
			});

		},

	});
</script>
