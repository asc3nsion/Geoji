<!-- 
This is an element button used as a base for other buttons.
 text = The text to be displayed on the button
 icon = The icon to be desplayed on the button
 iput = This is the id of the component the button will call a method on.

 style of the button is set via j-styles behavior.
 interaction is set via j-handler.
 if the button doesn't have an explicit id, one is assigned via auto-id.
-->
<!-- components: -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../elements/j-ui/j-button.html">
<link rel="import" href="../../elements/j-ui/j-profile-img.html">
<link rel="import" href="../../elements/j-ui/j-dialog.html">
<link rel="import" href="../../elements/api/imgur-upload.html">
<!-- behaviors: -->
<link rel="import" href="../../behaviors/style/j-styles.html">
<link rel="import" href="../../behaviors/interaction/j-handler.html">
<link rel="import" href="../../behaviors/selection/auto-id.html">
<link rel="import" href="../../behaviors/util/j-util.html">

<style>

google-map {
    height: 30vh;
    width: 60vw;
}

paper-icon-button.createMarker #icon {

	left: 2vw;
  	padding: 5px;
    width: 100%;
    height: 100%;
 }

 paper-icon-button.createMarker{
    width: 20%;
    height: 8vh;
 }

 iron-icon.createMarker{
 	margin: 0px 0px 0px 22%;
    width: 55%;
    height: 10%;
 }

 iron-image.createMarker{
 	margin: auto;
    max-width:100%;
	max-height:100%
 }

 input.createMarker{
 	margin: 1% 0;
    bottom:10%;
    width: 50%;
 }

 paper-button.saveGeoji{
 	float: right;
    margin: 2% 0 10px 10px;
 }

 gold-email-input.createMarker{
 	background-color: orange;
 	color:red;
 }

 paper-input-container.createMarker{

 	width: 85%;
 	margin: 10px 10px 10px 10px;
 }
 paper-input-container.txtData{
 	margin: auto;
	background-color: #EBF0B1;
 	width: 80%;
 }
 paper-dialog.txtData{

 	width: 35vw;
 	height: 55%;
 }
 paper-button.txtData{
 	float: right;
 	margin: 50px 10px 10px 10px;
 }
 paper-dialog.imgData{

 	width: 35vw;
 	height: 60%;

 }
 paper-dialog.vidData{

 	width: 45vw;
 	height: 65%;

 }
 paper-icon-button.closeDialog{

 }
 paper-card.emailList{
 	display: inline-block;
 }
 paper-spinner-lite.saveSpinner {
 	width:300px;
 	height:300px;
 	--paper-spinner-stroke-width:10px;
 }
 paper-progress.bar {
 	margin: auto;
 	width:80%;
 }

</style>	

<dom-module id= "geoji-editor">
	<template>

		<firebase-collection
	    	id="{{assignCtrl('geojiPublic')}}"
			limit-to-first="3"
		    location="https://geoji.firebaseio.com/public/"
		    data="{{publicData}}">
		</firebase-collection>

		<firebase-collection
	    	id="{{assignCtrl('geojiPrivate')}}"
			limit-to-first="3"
		    location="https://geoji.firebaseio.com/private/"
		    data="{{privateData}}">
		</firebase-collection>

		<geo-location id="{{assignCtrl('location')}}"  watch-pos latitude="{{currentLatitude}}" longitude="{{currentLongitude}}"></geo-location>

		<paper-card id="{{assignCtrl('geojiCard')}}" heading="" image="{{cardImage}}">
			<paper-input-container class="createMarker">
			  <label>Title</label>
			  <input id="{{assignCtrl('title')}}" class="createMarker" is="iron-input" bind-value="{{title}}">
			  <paper-icon-button suffix icon="clear"></paper-icon-button>
			</paper-input-container>
		  <div class="card-content">
		  <div id="{{assignCtrl('containerPrivate')}}">
		  	<paper-toggle-button id="{{assignCtrl('public')}}"  checked="{{private}}">Private</paper-toggle-button>
		  	<paper-input-container id="{{assignCtrl('email')}}" class="createMarker" bind-value="{{emailValue}}" hidden="true">
			  <label>Add Email</label>
			  <input id="{{assignCtrl('emailInput')}}" is="iron-input" bind-value="">
			  <paper-input-error>Enter a valid email!</paper-input-error>
			  <paper-icon-button suffix icon="add" on-tap="addEmail"></paper-icon-button>
			</paper-input-container>
		  </div>
		  <div id="{{assignCtrl('containerEncrypt')}}">
		  	<paper-toggle-button id="{{assignCtrl('encrypt')}}" checked="{{encrypted}}">Encrypt</paper-toggle-button>
		  	<paper-input-container id="{{assignCtrl('cipher')}}" class="createMarker" bind-value="{{emailValue}}" hidden="true">
			  <label>Cipher Key</label>
			  <input id="{{assignCtrl('cipherInput')}}" is="iron-input" bind-value="{{cipherText}}">
			  <input id="cipherHidden" is="iron-input" bind-value="{{cipherText}}" hidden="true">
			  <paper-input-error>Enter or Generate cipher</paper-input-error>
			  <paper-icon-button suffix icon="autorenew" on-tap="createcipher"></paper-icon-button>
			  <paper-icon-button id="{{assignCtrl('cipherCopy')}}" suffix icon="content-copy" on-tap="copycipher" class="cut" data-clipboard-action="copy" data-clipboard-target="#cipherHidden"></paper-icon-button>
			</paper-input-container>
		  </div>
		  			
			<paper-card id="{{assignCtrl('list')}}">{{emailString}}</paper-card>
			<!-- <gold-email-input id="{{assignCtrl('email')}}" class="createMarker" label="add email" hidden="true"></gold-email-input> -->
		  </div>
		  <google-map 
		  id="{{assignCtrl('map')}}"
		  latitude="{{currentLatitude}}" 
		  longitude="{{currentLongitude}}" 
		  min-zoom="9" 
		  max-zoom="30"
          language="en" 
          api-key="AIzaSyCgmlzQ8iH-U2KDt2mhXJbZvQm-KB5dWSo"
          clickEvents="true" 
          google-map-dblclick="placeMarker"
          fitToMarkers="true"
          zoom="20"
          drag-events="true">
		  <google-map-marker id="{{assignCtrl('targetMarker')}}" latitude="{{currentLatitude}}" longitude="{{currentLongitude}}"
		                     draggable="true" drag-events="true" click-events="true" icon="/images/marker-target.png"></google-map-marker></google-map>

		  <div class="card-actions">
		    <paper-icon-button on-tap="txtMarker" icon="geoji-icons:mascot-txt" class="createMarker"></paper-icon-button>
		    <paper-icon-button on-tap="imgMarker" icon="geoji-icons:mascot-img" class="createMarker"></paper-icon-button>
		    <paper-icon-button on-tap="vidMarker" icon="geoji-icons:mascot-vid" class="createMarker"></paper-icon-button>
		    <paper-button id="{{assignCtrl('add')}}" class="saveGeoji" raised on-tap="addGeoji">ADD</paper-button>
		    <paper-button id="{{assignCtrl('save')}}" class="saveGeoji" raised on-tap="saveGeoji" hidden="true">SAVE</paper-button>
		  </div>
		</paper-card>

		<paper-dialog class="txtData" id="{{assignCtrl('txtDialog')}}" modal role="alertdialog">
			<h2>Geoji Message</h2>
			<paper-icon-button suffix class="closeDialog" icon="clear" on-tap=""></paper-icon-button>
			<paper-input-container id="{{assignCtrl('txtContainer')}}" class="txtData" bind-value="">
			  <textarea id="{{assignCtrl('txtInput')}}" class="txtData" rows="10" cols="30"></textarea> 
			</paper-input-container>
			<paper-button id="{{assignCtrl('cancelTxt')}}" class="txtData theme" raised on-tap="toggleTxtDialog">CANCEL</paper-button>
			<paper-button id="{{assignCtrl('saveTxt')}}" class="txtData theme" raised on-tap="saveTxt">SAVE</paper-button>
		</paper-dialog>

		<paper-dialog class="imgData" id="{{assignCtrl('imgDialog')}}" modal role="alertdialog">
			<h2>Geoji Image</h2>
			<paper-toggle-button id="{{assignCtrl('coverImg')}}"  checked="{{coverSet}}" class="inlineBlock">Cover Image</paper-toggle-button>
			<paper-spinner-lite id="{{assignCtrl('imgSpinner')}}"  class="orange createMarker"></paper-spinner-lite>
			<div id="{{assignCtrl('tempImgs')}}" >
				<iron-icon id="{{assignCtrl('imgIcon')}}" icon="geoji-icons:mascot-img-icon" class="createMarker"></iron-icon>
			</div>
			<j-img-process 
			id="{{assignCtrl('imgProcess')}}" 
			imgur="true" 
			fixed="true" 
			fixedSize="200"
			width="200"
			height="200" 
			hideButtons="false"
			handleDialog="{{getCtrlId('imgDialog')}}"
			parentElement="{{getCtrlId('imgDialog')}}"
			progressSpinner="{{getCtrlId('imgSpinner')}}"
			></j-img-process>
		</paper-dialog>

		<paper-dialog class="vidData" id="{{assignCtrl('vidDialog')}}" modal role="alertdialog">
			<paper-progress class="bar" id="{{assignCtrl('vidProgress')}}"></paper-progress>
			<h2 class="inlineBlock">Geoji Video</h2>
			<paper-spinner-lite id="{{assignCtrl('vidSpinner')}}"  class="orange inlineBlock"></paper-spinner-lite>
			<paper-toggle-button id="{{assignCtrl('vidPrivate')}}" checked="{{vidPrivate}}">Private</paper-toggle-button>
			<paper-input-container id="{{assignCtrl('vidTitle')}}" class="createMarker" bind-value="{{vidTitle}}">
			  <label>Title</label>
			  <input id="{{assignCtrl('vidTitleInput')}}" is="iron-input" bind-value="">
			</paper-input-container>
			<paper-input-container id="{{assignCtrl('vidUrl')}}" class="createMarker unselectable" bind-value="{{vidTitle}}">
			  <label>Link</label>
			  <input id="{{assignCtrl('vidUrlInput')}}" is="iron-input" bind-value="{{vidId}}" class="unselectable" disabled>
			</paper-input-container>
			<div id="{{assignCtrl('vidImgs')}}" >
				<iron-icon id="{{assignCtrl('vidIcon')}}" icon="geoji-icons:mascot-img-icon" class="createMarker"></iron-icon>
			</div>
			<google-youtube
			  id="{{assignCtrl('youtubePlayer')}}"
			  video-id="{{vidUrl}}"
			  height="270px"
			  width="480px"
			  rel="0"
			  autoplay="0"
			  hidden="true">
			</google-youtube>
			<j-vid-process
			 id="{{assignCtrl('vidProcess')}}"
			 title="{{vidTitle}}"
			 videoId="{{vidId}}"
			 auto="true"
			 privacyStatus="{{vidPrivacyStatus}}"
			 categoryId = "22"
			 ></j-vid-process>
		</paper-dialog>

		<paper-dialog class="vidData" id="{{assignCtrl('saveDialog')}}" modal role="alertdialog">
			<h2>Saving Geoji</h2>
			<paper-spinner-lite id="{{assignCtrl('saveSpinner')}}"  class="orange createMarker saveSpinner center"></paper-spinner-lite>
		</paper-dialog>

	</template>
</dom-module>

<script>
	// I pass the button handler property from the base element, defined as the input
	// The call back is made via document.querySelector on the input element name.

	Polymer({		
		is: "geoji-editor",
		properties: {
			title: {
				type: String,
				value: "",
				observer: "_setTitle",
				notify: true
			},
			private: {
				type: Boolean,
				value: false,
				observer: "_setPrivate",
				notify: true
			},
			encrypted: {
				type: Boolean,
				value: false,
				observer: "_setEncrypted",
				notify: true
			},
			cardImg: {
				type: String,
				value: ""
			},
			heading: {
				type: String,
				value: "GEOJI"
			},
			detail: {
				type: String,
				value: ""
			},
			coverSet: {
				type: String,
				observer: "_setCoverImg",
				notify: true
			},
			coverImg: {
				type: String
			},
			description: {
				type: String,
				value: ""
			},
			currentLongitude: {
				type: String,
				observer: "locationChange",
				notify: true
			},
			currentLatitude: {
				type: String,
				observer: "locationChange",
				notify: true
			},
			markerArray: {
				type: Array,
				value:[]
			},
			publicData: {
				type: Array,
				value:[]
			},
			geoji: {
				type: Object,
				value: {}
			},
			geojiEncrypted: {
				type: Object,
				value: {},
				observer: "_checkEncrypted",
				notify: true
			},
			vidTitle: {
				type: String,
				value: "new video",
				observer: "_setVidTitle",
				notify: true
			},
			vidPrivate: {
				type: Boolean,
				value: false,
				observer: "_setVidPrivate",
				notify: true
			},
			vidPrivacyStatus: {
				type: String,
				value: "public",
				observer: "_setVidPrivate",
				notify: true
			},
			vidId: {
				type: String,
				value: "new video",
				observer: "_setVidId",
				notify: true
			},
			vidUrl: {
				type: String,
				value: ""
			},
			emailValue: {
				type: String,
				value: "",
				observer: "_storeEmails",
				notify: true
			},
			emailList: {
				type: Array,
				value: []
			},
			emailString: {
				type: String,
				value: "",
				observer: "_updateEmails",
				notify: true
			},
			selectedMarker: {
				type: String
			},
			cipherText: {
				type: String
			}
			
		},

		behaviors:[StyleBehaviors.JStyles, InteractionBehaviors.JHandler, SelectionBehaviors.AutoId, UtilityBehaviors.JUtil],

		ready: function(){

		},
		attached: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var target = this.getElem(this.ctrls.targetMarker);
			var targetObj = {};
			var title = this.getElem(this.ctrls.title);
			var email = this.getElem(this.ctrls.email);
			var public = this.getElem(this.ctrls.public);
			var email = this.getElem(this.ctrls.email);
			var emailInput = this.getElem(this.ctrls.emailInput);
			var encrypt = this.getElem(this.ctrls.encrypt);
			var cipher = this.getElem(this.ctrls.cipher);
			var cipherInput = this.getElem(this.ctrls.cipherInput);
			var cipherCopy = this.getElem(this.ctrls.cipherCopy);
			var imgDialog = this.getElem(this.ctrls.imgDialog);
			var imgProcess = this.getElem(this.ctrls.imgProcess);
			var imgIcon = this.getElem(this.ctrls.imgIcon);
			var imgSpinner = this.getElem(this.ctrls.imgSpinner);
			var vidSpinner = this.getElem(this.ctrls.vidSpinner);
			var vidProgress = this.getElem(this.ctrls.vidProgress);
			var vidUrlInput = this.getElem(this.ctrls.vidUrlInput);
			var vidDialog = this.getElem(this.ctrls.vidDialog);
			var vidProcess = this.getElem(this.ctrls.vidProcess);
			var containerPrivate = this.getElem(this.ctrls.containerPrivate);
			var containerEncrypt = this.getElem(this.ctrls.containerEncrypt);

			title.focus();
			title.value = " ";
			title.blur();
			
			imgProcess.handleDialog = imgDialog.id;
			imgProcess.handleElement = imgIcon.id;
			imgProcess.progressSpinner = imgSpinner.id;
			vidProcess.progressSpinner = vidSpinner.id;
			vidProcess.progressBar = vidProgress.id;
			vidProcess.videoIdInput = vidUrlInput.id;
			vidProcess.handleDialog = vidDialog.id;

			this.clipboard = new Clipboard(cipherCopy);

			var inlines = [containerPrivate, containerEncrypt];
			var containers = [containerPrivate, containerEncrypt];

			var topStyle = {
				"vertical-align":"top"
			}
			var halfStyle = {
				"width": "2vw"
			}
			var containerStyle = {
				"top": "1vh",
				"bottom": "1vh",
				"height": "11vh",
				"vertical-align":"top"
			}

			for(i in inlines){
				this.assignClass(inlines[i], "inlineHalf");
			}

			for(i in containers){
				this.assignStyles(containers[i], containerStyle);
			}

			this.geoji = {};
			map.mapType="satellite";

			targetObj.longitude = this.currentLongitude;
			targetObj.latitude = this.currentLatitude;
			this.geoji.target = targetObj;

			this.geoji.private = public.checked;

			setTimeout(function(){

		        self.geoji.target.longitude = self.currentLongitude;
		        self.geoji.target.latitude = self.currentLatitude;
		        targetObj.longitude = self.currentLongitude;
				targetObj.latitude = self.currentLatitude;

		    }, 1000);

			this.clipboard.on('success', function(e) {
			    console.log(e);
			    document.execCommand("copy", true, e.text);
			});
			this.clipboard.on('error', function(e) {
				console.log("ERROR!");
			    console.log(e);
			});

			var onClick = function(e) {
				    console.log(e);
				};
			var mapDragEnd = function(e) {

				    self.geoji.target.longitude = target.longitude;
				    self.geoji.target.latitude = target.latitude;

				    console.log(self.geoji);
				};
			var targetDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);

				    self.geoji.target.longitude = latLng.lng();
				    self.geoji.target.latitude = latLng.lat();

				    console.log(self.geoji);
				};

			document.addEventListener('imgur-upload-success', function(e) {

				

			  if(imgDialog.id === imgProcess.parentElement.id){

			  	self.geoji[self.selectedMarker].img = e.detail.link;

			  	imgDialog.toggle();
			  }

	        });
	        document.addEventListener('imgur-upload-failure', function(e) {
	          console.log(e);
	          alert(e.detail.data.error);
	        });

			map.resize();

			target.addEventListener('google-map-marker-dragend', targetDragEnd);
			map.addEventListener('google-map-dragend', mapDragEnd);
		},
		addGeoji: function(){
			var add = this.getElem(this.ctrls.add);
			var save = this.getElem(this.ctrls.save);
			var geoji = this.geoji;
			var cipher = this.getElem(this.ctrls.cipherInput).value;
			var saveDialog = this.getElem(this.ctrls.saveDialog);
			var saveSpinner = this.getElem(this.ctrls.saveSpinner);
			var publicDB = this.getElem(this.ctrls.geojiPublic);
			var privateDB = this.getElem(this.ctrls.geojiPrivate);
			var saveGeoji = {};

			saveDialog.open();
			saveSpinner.active = true;

			if(this.geoji!==null && this.geoji!==undefined){

				if((this.geoji.encrypted)&&(cipher !== null || cipher !== undefined || cipher !== "")){
					this._encryptGeoji();
				}else{
					if(!this.geoji.private){
						if(publicDB !== null && publicDB !== undefined){
							publicDB.add(this.geoji);
							add.hidden = true;
							save.hidden = false;
							saveDialog.close();
						}
					}else{
						if(privateDB !== null && privateDB !== undefined){
							privateDB.add(this.geoji);
							add.hidden = true;
							save.hidden = false;
							saveDialog.close();
						}
					}
				}
			}


		},
		saveGeoji: function(){
			var geoji = this.geoji;
			var cipher = this.getElem(this.ctrls.cipherInput).value;
			var saveDialog = this.getElem(this.ctrls.saveDialog);
			var saveSpinner = this.getElem(this.ctrls.saveSpinner);
			var publicDB = this.getElem(this.ctrls.geojiPublic);
			var saveGeoji = {};

			saveDialog.open();
			saveSpinner.active = true;

			if(this.geoji!==null && this.geoji!==undefined){

				if((geoji.encrypted)&&(cipher !== null || cipher !== undefined || cipher !== "")){
					saveGeoji = this._encryptGeoji();
				}else{

				}
			}

			if(publicDB !== null && publicDB !== undefined){
				//publicDB.add(saveGeoji);
			}
			//this.$.firebasePublicData.add(mainObj);
		},
		createMarker: function(){
			var map = this.getElem(this.ctrls.map);
			var id = this.makeId();
			var marker = document.createElement('google-map-marker');
			marker.setAttribute('latitude', this.currentLatitude);
			marker.setAttribute('longitude', this.currentLongitude);
			marker.setAttribute('drag-events', true);
			marker.setAttribute('click-events', true);
			marker.draggable = true;
			marker.animation = "DROP";
			marker.id = this.assignCtrl(id);

			return marker;
		},
		setMarkerListeners: function(id, click, dblclick, dragend){

			var self = this;

			setTimeout(function(){
		        var elem = self.getElem(id);
		        self.markerArray.push(id);

				elem.addEventListener('google-map-marker-click', click);
				elem.addEventListener('google-map-marker-click', dblclick);
				elem.addEventListener('google-map-marker-dragend', dragend);
		    }, 50);
		},
		storeMarker: function(id, obj){
			this.geoji[id] = obj;
		},
		toggleDialog: function(event){
			console.log("event");
			console.log(event);
			var id = event.target.id;
			var type = this.geoji[id].type;
			var message = this.geoji[id].message;
			var marker = document.querySelector("#"+id);

			if(type !== undefined && type !== null){

				if(type === "img"){
					var coverImg = this.coverImg;
					var coverSet = this.coverSet;

					this.getElem(this.ctrls.imgProcess).hideButtons = false;

					if(coverImg !== null && coverImg !== null){

					}
				}

				var e = this.getElem(this.ctrls[type+"Dialog"]);
				e.toggle();

			}

			console.log(event);
		},
		toggleTxtDialog: function(){

			var e = this.getElem(this.ctrls.txtDialog);
			e.toggle();
		},
		txtMarker: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var marker = this.createMarker();
			var txt = this.getElem(this.ctrls.txtInput);
			var geoji = this.geoji;
			marker.icon = "/images/mascot-txt.png";

			var onClick = function(e) {
				    console.log(e);
				};
			var dblClick = function(e) {
					var message = self.geoji[e.target.id].message;
				    self.selectedMarker = e.target.id;

				    if(message !== null && message !== undefined){

						txt.value = message;
					}else if(message === null || message === undefined){

						txt.value = "";
					}

					self.toggleDialog(e);

				};
			var onDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);
					var data = geoji[marker.id];
				    
				    if(data !== undefined || data !== null){
				    	data.longitude = latLng.lng();
				    	data.latitude = latLng.lat();
				    }

				    console.log(geoji);
				};

			Polymer.dom(map).appendChild(marker);
			this.setMarkerListeners(marker.id, onClick, dblClick, onDragEnd);
			self.updateMarker(marker);

		},
		saveTxt: function(){
			var txt = this.getElem(this.ctrls.txtInput);
			var marker = this.getElem(this.selectedMarker);
			var type = this.geoji[marker.id].type;

			if(type == "txt"){
				this.geoji[marker.id].message = txt.value;
				this.toggleTxtDialog();
				txt.value = "";
			}

		},
		imgMarker: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var marker = this.createMarker();
			var geoji = this.geoji;
			marker.icon = "/images/mascot-img.png";

			var onClick = function(e) {
				    console.log(e);
				};
			var dblClick = function(e) {
					var imgUrl = self.geoji[e.target.id].img;
					var imgProcess = self.getElem(self.ctrls.imgProcess);
					var imgIcon = self.getElem(self.ctrls.imgIcon);

					self.toggleDialog(e);
				    self.selectedMarker = e.target.id;
				    
				    if(imgUrl !== null && imgUrl !== undefined){
				    	console.log("this is the img url::::");
				    	console.log(imgUrl);
				    	console.log("imgProcess.ctrls.imgPreview.src");
				    	console.log(imgProcess.ctrls);
				    	console.log("imgProcess.ctrls.imgPreview.src");
				    	imgProcess.setImgPreview(imgUrl);
				    	imgIcon.hidden = true;
				    	imgProcess.showCropper();
				    }else{
				    	imgProcess.hideCropper();
				    	imgIcon.hidden = false;
				    }
				};
			var onDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);
				    var data = geoji[marker.id];
				    
				    if(data !== undefined || data !== null){
				    	data.longitude = latLng.lng();
				    	data.latitude = latLng.lat();
				    }
				};
				
			Polymer.dom(map).appendChild(marker);
			this.setMarkerListeners(marker.id, onClick, dblClick, onDragEnd);
			this.updateMarker(marker);

		},
		saveImg: function(){

			var marker = this.getElem(this.selectedMarker);
			var type = this.geoji[marker.id].type;

			if(type == "img"){

			}

		},
		vidMarker: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var marker = this.createMarker();
			var geoji = this.geoji;

			marker.icon = "/images/mascot-vid.png";

			var onClick = function(e) {
				    console.log(e);
				};
			var dblClick = function(e) {
				    self.toggleDialog(e);
				    self.selectedMarker = e.target.id;
				    if(self.geoji[e.target.id]!==null && self.geoji[e.target.id]!==undefined){

				    	var marker = self.geoji[e.target.id];
				    	var vidTitle = self.getElem(self.ctrls.vidTitleInput);
				    	var vidId = self.getElem(self.ctrls.vidIdInput);
				    	var vidPrivate = self.getElem(self.ctrls.vidPrivate);
				    	var vidIcon = self.getElem(self.ctrls.vidIcon);
				    	var player = self.getElem(self.ctrls.youtubePlayer);
				    	console.log(marker);

				    	if(marker.privacyStatus === "private"){
				    		vidPrivate.checked = true;
				    	}else{
				    		vidPrivate.checked = false;
				    	}

				    	if(marker.link !== null && marker.link !== undefined && marker.link !== ""){
				    		vidTitle.value = marker.title;
				    		console.log(marker.link);

					    	if(vidId !== null && vidId !== undefined && self.vidUrl !== null && self.vidUrl !== undefined){
					    		vidId.value = marker.link;
					    		self.vidUrl = marker.link;
					    	}

				    		vidIcon.hidden = true;
				    		player.hidden = false;
				    	}else{

				    		vidTitle.value = "";

				    		if(vidId !== null && vidId !== undefined && self.vidUrl !== null && self.vidUrl !== undefined){
					    		vidId.value = "";
					    		self.vidUrl = "";
					    	}

				    		vidIcon.hidden = false;
				    		player.hidden = true;
				    	}

				    }
				};
			var onDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);
				    var data = geoji[marker.id];
				    
				    if(data !== undefined || data !== null){
				    	data.longitude = latLng.lng();
				    	data.latitude = latLng.lat();
				    }
				};
				
			Polymer.dom(map).appendChild(marker);
			this.setMarkerListeners(marker.id, onClick, dblClick, onDragEnd);
			this.updateMarker(marker);

		},
		updateMarker: function(marker){
			console.log(marker);
			var target = this.getElem(this.ctrls.targetMarker);
			var targetObj = {};
			var icon = marker.icon;
			var obj = {};


			if(icon !== null){
				if(icon.includes("txt")>0){
					obj.type = "txt";
				}else if(icon.includes("img")>0){
					obj.type = "img";
				}else if(icon.includes("vid")>0){
					obj.type = "vid";
				}
			}
			targetObj.longitude = target.longitude;
			targetObj.latitude = target.latitude;
			this.geoji.target = targetObj;
			obj.latitude = marker.latitude;
			obj.longitude = marker.longitude;
			this.geoji[marker.id] = obj;
		},
		pixelOffsetToLatLng: function(offsetx, offsety) {
		  var map = document.querySelector('google-map').map;
		  var latlng = map.getCenter();
		  var scale = Math.pow(2, map.getZoom());
		  var nw = new google.maps.LatLng(
		      map.getBounds().getNorthEast().lat(),
		      map.getBounds().getSouthWest().lng()
		  );

		  var worldCoordinateCenter = map.getProjection().fromLatLngToPoint(latlng);
		  var pixelOffset = new google.maps.Point((offsetx/scale) || 0,(offsety/scale) ||0);

		  var worldCoordinateNewCenter = new google.maps.Point(
		      worldCoordinateCenter.x - pixelOffset.x,
		      worldCoordinateCenter.y + pixelOffset.y
		  );

		  var latLngPosition = map.getProjection().fromPointToLatLng(worldCoordinateNewCenter);

		  return latLngPosition;
		},
		addEmail: function(){
			var input = this.getElem(this.ctrls.emailInput);
			var email = this.getElem(this.ctrls.email);
			console.log(this.emailValue);
			//this.emailList.push(email.value);
			if(this.emailValidate()&&(!this.emailString.includes(this.emailValue))){
				input.invalid = false;
				this.emailString += "  " + this.emailValue + ",";
				this.emailList.push(this.emailValue);
				this.geoji.emailList.push(this.emailValue);
				input.value = "";
			}else{
				email.invalid = true;
				input.value = "";
			}
			

		},
		emailValidate: function(){
			var input = this.getElem(this.ctrls.emailInput);
			var email = this.getElem(this.ctrls.email);
			if(email !== null&& input !== null){
				if(input.value.includes('@')&&input.value.includes('.')){
					email.invalid = false;
					return true;
				}else{
					return false;
				}
			}
			console.log("validate");
		},
		createcipher: function(){
			var symbols = ["!", "@", "$", "%", "^", "&", "*", "_"];
			var sym1 = symbols[this.getRandomInt(0, symbols.length)];
			var sym2 = symbols[this.getRandomInt(0, symbols.length)];
			var randomString = Math.random().toString(36).slice(-8)+Math.random().toString(36).slice(-8)+sym1+sym2;
			randomString = this.shuffleString(randomString);

			var cipherInput = this.getElem(this.ctrls.cipherInput);

			cipherInput.value = randomString;
		},
		copycipher: function(){
			var cipherInput = this.getElem(this.ctrls.cipherInput);
			var cipherCopy = this.getElem(this.ctrls.cipherCopy);
			var hidden = document.querySelector("#cipherHidden");
			var cipher = cipherInput.value;
			hidden.value = cipher;

			cipherCopy["data-clipboard-text"] = cipher;
			//console.log(this.clipboard);
			
			//window.prompt("Copy to clipboard: Ctrl+C, Enter", cipherInput.value);
		},
		encryptData: function(key, data, cipher){
			var self = this;
			console.log(data + " " + cipher + "  encrypting...");


			triplesec.encrypt ({

				data:          new triplesec.Buffer(data),
				key:           new triplesec.Buffer(cipher),
				progress_hook: function (obj) { /* ... */ }

			}, function(err, buff) {

				if (! err) {
						var ciphertext = buff.toString('hex');
						var keys = Object.keys(self.geoji);
						var eKeys = Object.keys(self.geojiEncrypted);

						//console.log(ciphertext);
						self.geojiEncrypted[key] = ciphertext;

						if(keys.length === eKeys.length){
							var eObj = self.geojiEncrypted[key];
							var gObj = self.geoji[key];
							var keysE = Object.keys(eObj);
							var keysO = Object.keys(gObj);

							if(keysE.length === keysO.length){
								self._checkEncrypted();
							}
						}
					}

			});

		},
		encryptInnerData: function(key, innerKey, data, cipher){
			console.log(data + " " + cipher + "  encrypting...");
			var obj = this.geoji;
			var keys = Object.keys(obj);
			var self = this;

			triplesec.encrypt ({

				data:          new triplesec.Buffer(data),
				key:           new triplesec.Buffer(cipher),
				progress_hook: function (obj) { /* ... */ }

			}, function(err, buff) {

				if (! err) {
						var ciphertext = buff.toString('hex');
						var keys = Object.keys(self.geoji);
						var eKeys = Object.keys(self.geojiEncrypted);
						
						//console.log(key);
						//console.log(innerKey);
						//console.log(ciphertext);



						if(self.geojiEncrypted[key]===null || self.geojiEncrypted[key]===undefined){
							self.geojiEncrypted[key] = {};
						}

						if(innerKey !== "type"){
							self.geojiEncrypted[key][innerKey] = ciphertext;
						}else{
							self.geojiEncrypted[key].type = self.geoji[key].type;
						}

						if(keys.length === eKeys.length){
							var eObj = self.geojiEncrypted[key][innerKey];
							var gObj = self.geoji[key][innerKey];
							var keysE = Object.keys(eObj);
							var keysO = Object.keys(gObj);

							if(keysE.length === keysO.length){
								// console.log(ciphertext);
								// console.log("self.geojiEncrypted[key]");
								// console.log(self.geojiEncrypted[key]);
								self._checkEncrypted();
							}
						}

						//console.log(self.geojiEncrypted);
					}

			});

		},
		encryptArrayData: function(key, cipher){
			var self = this;

			triplesec.encrypt ({

				data:          new triplesec.Buffer(data),
				key:           new triplesec.Buffer(cipher),
				progress_hook: function (obj) { /* ... */ }

			}, function(err, buff) {

				if (! err) {
						var ciphertext = buff.toString('hex');
						var keys = Object.keys(self.geoji);
						var eKeys = Object.keys(self.geojiEncrypted);
						
						//console.log(ciphertext);
						console.log(ciphertext);

						self.geojiEncrypted[key] = ciphertext;

						if(keys.length === eKeys.length){
							var eObj = self.geojiEncrypted[innerKey];
							var gObj = self.geoji[innerKey];
							var keysE = Object.keys(eObj);
							var keysO = Object.keys(gObj);

							if(keysE.length === keysO.length){
								// console.log(ciphertext);
								// console.log("self.geojiEncrypted[key]");
								// console.log(self.geojiEncrypted[key]);
								self._checkEncrypted();
							}
						}
					}

			});

		},
		encryptObj: function(key, obj, cipher){

			console.log("start encrypt object.");

			for(k in obj){
				this.encryptInnerData(key, k, obj[k], cipher);
			}

		},
		encryptArray: function(key, cipher){
			var self = this;
			var array = this.geoji[key];

			if(array.constructor === Array){
				for(i in array){
					triplesec.encrypt ({

						data:          new triplesec.Buffer(data),
						key:           new triplesec.Buffer(cipher),
						progress_hook: function (obj) { /* ... */ }

					}, function(err, buff) {

						if (! err) {
								var ciphertext = buff.toString('hex');
								var keys = Object.keys(self.geoji);
								var eKeys = Object.keys(self.geojiEncrypted);
								
								console.log(ciphertext);
								
								self.geojiEncrypted[key].push(ciphertext);

								if(keys.length === eKeys.length){
									var keysE = Object.keys(eObj);
									var keysO = Object.keys(gObj);

									if(keysE.length === keysO.length){
										// console.log("self.geojiEncrypted[key]");
										// console.log(self.geojiEncrypted[key]);
										self._checkEncrypted();
									}
								}
							}
					});
				}
			}else{
				console.log("Must be type of array to encrypt.")
			}

			console.log("start encrypt object.");

		},
		locationChange: function(){
			var geoji = this.geoji;
			// if(geoji !== null && geoji !== undefined){
			// 	var target = this.geoji.target;
			// 	var lat = this.currentLatitude;
			// 	var long = this.currentLongitude;

			// 	console.log("location change: " + this.currentLatitude);
			// 	//console.log(this.geoji.target);
			// 	//geoji.target.longitude = long;
			// 	// geoji.target.latitude = this.currentLatitude;
			// }
		},
		_encryptGeoji: function(){
			var geoji = {};
			var cipher = this.getElem(this.ctrls.cipherInput).value;
			var saveDialog = this.getElem(this.ctrls.saveDialog);
			var obj = this.geoji;
			var keys = Object.keys(obj);
			var length = Object.keys(obj).length;
			var self = this;
			var i = 0;

			this.geojiEncrypted = {};

			console.log("processObj---> "+keys[i]);

			for(key in obj){
				switch(key){
					case "title":
						console.log("encrypt title");
						self.encryptData(key, self.geoji.title, cipher);
						break;
					case "private":

						if(self.geoji.private !== null && self.geoji.private !== undefined){
							self.geojiEncrypted.private = self.geoji.private;
						}
						break;
					case "encrypted":
						console.log("encrypt encrypted");

						if(self.geoji.encrypted !== null && self.geoji.encrypted !== undefined){
							self.geojiEncrypted.encrypted = true;
						}
						break;
					case "emailList":
						console.log("encrypt email list");

						if(self.geoji.emailList !== null && self.geoji.emailList !== undefined){
							self.geojiEncrypted.emailList = [];
							self.encryptArray(key, cipher);
						}
							
							break;
					default:
						console.log("default");

						if(typeof self.geoji[key]==="object"){
							// console.log("encrypt object");
							// console.log("the key is: "+key);
							// console.log(self.geoji[key]);
							self.encryptObj(key, self.geoji[key], cipher);
						}
							
						break;
				}
				i++;
			}

		},
		_getCurrentLocation: function(){
			console.log("getting current location.");
		},
		_setTitle: function(){
			var title = this.getElem(this.ctrls.title);

			if(title !== null){
				this.geoji.title = title.value;
			}
		},
		_setPrivate: function(){
			var userEmail = app.data.email;
			var emailInput = this.getElem(this.ctrls.emailInput);
			var geojiEmails;
			var pToggle = this.getElem(this.ctrls.public);

			if((this.geoji !== null && this.geoji !== undefined)){
				var geojiEmails = this.geoji.emailList;
				if(geojiEmails === null || geojiEmails === undefined){
					this.geoji.emailList = [];
				}
			}

			if(pToggle !== null){
				this.geoji.private = pToggle.checked;
				this.getElem(this.ctrls.email).hidden = !pToggle.checked;

				if(this.getElem(this.ctrls.email).hidden === false){
					emailInput.focus();
					emailInput.value = " ";
					emailInput.blur();
					if(!this.emailString.includes(userEmail)){
						this.emailString += "  " + userEmail + ",";
						this.emailList.push(userEmail);
						this.geoji.emailList.push(userEmail);
					}
				}else if(this.getElem(this.ctrls.email).hidden === true){
					console.log("clear emails");
					this.emailString = " ";
					this.emailList=[];
					this.geoji.emailList = [];
				}

			}
		},
		_setEncrypted: function(){
			var cipherInput = this.getElem(this.ctrls.cipherInput);
			var pToggle = this.getElem(this.ctrls.encrypt);

			if(pToggle !== null){
				this.geoji.encrypted = pToggle.checked;
				this.getElem(this.ctrls.cipher).hidden = !pToggle.checked;
				if(this.getElem(this.ctrls.cipher).hidden === false){
					cipherInput.focus();
					cipherInput.value = " ";
					cipherInput.blur();
				}
			}
		},
		_checkEncrypted: function(){
			var self = this;
			var add = this.getElem(this.ctrls.add);
			var save = this.getElem(this.ctrls.save);
			var keys = Object.keys(this.geoji);
			var eKeys = Object.keys(this.geojiEncrypted);
			var saveDialog = this.getElem(this.ctrls.saveDialog);
			var saveSpinner = this.getElem(this.ctrls.saveSpinner);
			var limit = eKeys.length;
			var objsEncrypted = false;
			var saved = false;
			var i = 1;

			var encryptComplete = function(){
				if(add !== undefined && add !== null){
					add.hidden = true;
					save.hidden = false;
					saveSpinner.active = false;
					saveDialog.close();
					saved = true;
				}
			}

			console.log("keys length: "+keys.length+" <---> eKeys length: "+eKeys.length);

			if (eKeys.length === keys.length && this.geojiEncrypted !== null && this.geojiEncrypted !== undefined){
				var publicDB = this.getElem(this.ctrls.geojiPublic);
				var privateDB = this.getElem(this.ctrls.geojiPrivate);
				console.log("ALL DATA SHOULD BE ENCRYPTED.");
				// console.log(this.geojiEncrypted);

				if(this.geojiEncrypted.private && privateDB !== null && privateDB !== undefined){
					setTimeout(function(){
						privateDB.add(self.geojiEncrypted);
						encryptComplete();
					}, 100);
				}else if(!this.geojiEncrypted.private  && publicDB !== null && publicDB !== undefined){
					setTimeout(function(){
						publicDB.add(self.geojiEncrypted);
						encryptComplete();
					}, 100);									
				}
			}
			
		},
		_setCoverImg: function(){
			var geoji = this.geoji;

			if(geoji !== null && geoji !== undefined){
				if(this.coverSet){
					this.geoji.cover_image = this.coverImg;	
				}
			}
		},
		_updateEmails: function(){
			console.log("helleo");
			// for(str in this.emailList){
			// 	console.log(str);
			// 	this.emailString += " " + str;
			// }
		},
		_storeEmails: function(){
			this.geoji.emailList = this.emailList;
		},
		_setVidTitle: function(){
			var vidTitle = this.getElem(this.ctrls.vidTitleInput);
			var selected = this.getElem(this.selectedMarker);

			if(this.geoji!==null && this.geoji!==undefined
			 && this.vidTitle!==null && this.vidTitle!==undefined
			 && this.selected!==null && this.selected!==undefined){
				this.geoji[selected].title = this.vidTitle;
			}
			
		},
		_setVidId: function(){
			var vidId = this.getElem(this.ctrls.vidIdInput);
			var vidIcon = this.getElem(this.ctrls.vidIcon);
			var player = this.getElem(this.ctrls.youtubePlayer);
			var selected = this.getElem(this.selectedMarker);

			console.log("video id set");

			if(this.geoji!==null && this.geoji!==undefined
			 && this.vidId!==null && this.vidId!==undefined
			 && this.selected!==null && this.selected!==undefined){
				this.geoji[selected].link = this.vidId;
				vidId.value = "https://youtu.be/"+this.vidId;
				vidicon.hidden = true;
			}
			
		},
		_setVidPrivate: function(){
			var vidPrivate = this.getElem(this.ctrls.vidPrivate);
			var selected = this.getElem(this.selectedMarker);

			console.log("video id set");

			if(this.geoji!==null && this.geoji!==undefined
			 && this.vidId!==null && this.vidId!==undefined
			 && this.selected!==null && this.selected!==undefined){
			 	if(vidPrivate.checked){
			 		this.geoji[selected].privacyStatus = "private";
			 		this.vidPrivacyStatus = "private";
			 	}else{
			 		this.geoji[selected].privacyStatus = "public";
			 		this.vidPrivacyStatus = "public";
			 	}

			}
			
		}

	});
</script>
