<!-- 
This is an element button used as a base for other buttons.
 text = The text to be displayed on the button
 icon = The icon to be desplayed on the button
 iput = This is the id of the component the button will call a method on.

 style of the button is set via j-styles behavior.
 interaction is set via j-handler.
 if the button doesn't have an explicit id, one is assigned via auto-id.
-->
<!-- components: -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../../elements/j-ui/j-button.html">
<link rel="import" href="../../elements/j-ui/j-profile-img.html">
<link rel="import" href="../../elements/j-ui/j-dialog.html">
<link rel="import" href="../../elements/api/imgur-upload.html">
<!-- behaviors: -->
<link rel="import" href="../../behaviors/style/j-styles.html">
<link rel="import" href="../../behaviors/interaction/j-handler.html">
<link rel="import" href="../../behaviors/selection/auto-id.html">

<style>

google-map {
    height: 30vh;
    width: 60vw;
}

paper-icon-button.createMarker #icon {

	left: 2vw;
  	padding: 5px;
    width: 100%;
    height: 100%;
 }

 paper-icon-button.createMarker{
    width: 20%;
    height: 8vh;
 }

 input.createMarker{
 	margin: 1% 0;
    bottom:10%;
    width: 50%;
 }

 paper-button.saveGeoji{
 	float: right;
    margin: 2% 0 10px 10px;
 }

 gold-email-input.createMarker{
 	background-color: orange;
 	color:red;
 }

 paper-input-container.createMarker{
 	--paper-input-container-color: black;
 	width: 50%;
 }
 paper-card.emailList{
 	float: right;
 }

</style>	

<dom-module id= "geoji-editor">
	<template>
		<geo-location id="{{assignCtrl('location')}}"  watch-pos latitude="{{currentLatitude}}" longitude="{{currentLongitude}}"></geo-location>
		<paper-card id="{{assignCtrl('geojiCard')}}" heading="{{heading}}" image="{{cardImage}}">
		  <div class="card-content">
		  	<paper-toggle-button id="{{assignCtrl('public')}}"  checked="{{private}}">Private</paper-toggle-button>
		  	<paper-input-container class="createMarker">
			  <label>Title</label>
			  <input id="{{assignCtrl('title')}}" class="createMarker" is="iron-input" bind-value="{{title}}">
			  <paper-icon-button suffix icon="clear"></paper-icon-button>
			</paper-input-container>
			<paper-input-container id="{{assignCtrl('email')}}" class="createMarker" hidden="true">
			  <label>Add Email</label>
			  <input class="createMarker" is="gold-email-input" bind-value="">
			  <paper-icon-button suffix icon="add"></paper-icon-button>
			</paper-input-container>
			<paper-card id="{{assignCtrl('list')}}">dsfsdf</paper-card>
			<!-- <gold-email-input id="{{assignCtrl('email')}}" class="createMarker" label="add email" hidden="true"></gold-email-input> -->
		  </div>
		  <google-map 
		  id="{{assignCtrl('map')}}"
		  latitude="{{currentLatitude}}" 
		  longitude="{{currentLongitude}}" 
		  min-zoom="9" 
		  max-zoom="30"
          language="en" 
          api-key="AIzaSyCgmlzQ8iH-U2KDt2mhXJbZvQm-KB5dWSo"
          clickEvents="true" 
          google-map-dblclick="placeMarker"
          fitToMarkers="true"
          zoom="21"
          mapType="satellite" >
		  <google-map-marker id="{{assignCtrl('targetMarker')}}" latitude="{{currentLatitude}}" longitude="{{currentLongitude}}"
		                     draggable="true" drag-events="true" click-events="true" icon="/images/marker-target.png"></google-map-marker></google-map>

		  <div class="card-actions">
		    <paper-icon-button on-tap="txtMarker" icon="geoji-icons:mascot-txt" class="createMarker"></paper-icon-button>
		    <paper-icon-button on-tap="imgMarker" icon="geoji-icons:mascot-img" class="createMarker"></paper-icon-button>
		    <paper-icon-button on-tap="vidMarker" icon="geoji-icons:mascot-vid" class="createMarker"></paper-icon-button>
		    <paper-button id="{{assignCtrl('save')}}" class="saveGeoji" raised on-tap="">SAVE</paper-button>
		  </div>
		</paper-card>

	</template>
</dom-module>

<script>
	// I pass the button handler property from the base element, defined as the input
	// The call back is made via document.querySelector on the input element name.
	Polymer({		
		is: "geoji-editor",
		properties: {
			title: {
				type: String,
				value: "",
				observer: "_setTitle",
				notify: true
			},
			private: {
				type: Boolean,
				value: false,
				observer: "_setPrivate",
				notify: true
			},
			cardImg: {
				type: String,
				value: ""
			},
			heading: {
				type: String,
				value: "GEOJI"
			},
			detail: {
				type: String,
				value: ""
			},
			description: {
				type: String,
				value: ""
			},
			currentLongitude: {
				type: String
			},
			currentLatitude: {
				type: String
			},
			markerArray: {
				type: Array,
				value:[]
			},
			geoji: {
				type: Object,
				value: {}
			}
			
		},

		behaviors:[StyleBehaviors.JStyles, InteractionBehaviors.JHandler, SelectionBehaviors.AutoId],

		ready: function(){

		},
		attached: function(){
			var map = this.getElem(this.ctrls.map);
			map.resize();

			// var e = this.getElem(this.ctrls.profileImgInput);
			// var p = this.getElem(this.ctrls.profileImgUpload);
			// var self = this;

			// e.addEventListener('change', function() {
   //          	p.file = this.files[0];
	  //           console.log(e.file);
	  //       });
			// document.addEventListener('imgur-upload-success', function(e) {
	  //         console.log(e);
	  //         self.url = e.detail.link;
	  //         self.customUrl = e.detail.link;
	  //       });
	  //       document.addEventListener('imgur-upload-failure', function(e) {
	  //         console.log(e);
	  //         alert(e.detail.data.error);
	  //       });
		},
		createMarker: function(){
			var map = this.getElem(this.ctrls.map);
			var id = this.makeId();
			var marker = document.createElement('google-map-marker');
			marker.setAttribute('latitude', this.currentLatitude);
			marker.setAttribute('longitude', this.currentLongitude);
			marker.setAttribute('drag-events', true);
			marker.setAttribute('click-events', true);
			marker.draggable = true;
			marker.animation = "DROP";
			marker.id = this.assignCtrl(id);

			return marker;
		},
		setMarkerListeners: function(id, click, dragend){

			var self = this;

			setTimeout(function(){
		        var elem = self.getElem(id);
		        self.markerArray.push(id);

				elem.addEventListener('google-map-marker-click', click);
				elem.addEventListener('google-map-marker-dragend',dragend);
		    }, 50);
		},
		storeMarker: function(id, obj){
			this.geoji[id] = obj;
		},
		txtMarker: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var marker = this.createMarker();
			var geoji = this.geoji;
			marker.icon = "/images/mascot-txt.png";

			var onClick = function(e) {
				    console.log(e);
				};
			var onDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);
					var data = geoji[marker.id];
				    
				    if(data !== undefined || data !== null){
				    	data.longitude = latLng.lng();
				    	data.latitude = latLng.lat();
				    }

				    console.log(geoji);
				};

			Polymer.dom(map).appendChild(marker);
			this.setMarkerListeners(marker.id, onClick, onDragEnd);
			self.updateMarker(marker);

		},
		imgMarker: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var marker = this.createMarker();
			var geoji = this.geoji;
			marker.icon = "/images/mascot-img.png";

			var onClick = function(e) {
				    console.log(e);
				};
			var onDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);
				    var data = geoji[marker.id];
				    
				    if(data !== undefined || data !== null){
				    	data.longitude = latLng.lng();
				    	data.latitude = latLng.lat();
				    }
				};
				
			Polymer.dom(map).appendChild(marker);
			this.setMarkerListeners(marker.id, onClick, onDragEnd);
			this.updateMarker(marker);

		},
		vidMarker: function(){
			var self = this;
			var map = this.getElem(this.ctrls.map);
			var marker = this.createMarker();
			var geoji = this.geoji;
			marker.icon = "/images/mascot-vid.png";

			var onClick = function(e) {
				    console.log(e);
				};
			var onDragEnd = function(e) {
					var latLng = self.pixelOffsetToLatLng(e.detail.pixel.x, e.detail.pixel.y);
				    var data = geoji[marker.id];
				    
				    if(data !== undefined || data !== null){
				    	data.longitude = latLng.lng();
				    	data.latitude = latLng.lat();
				    }
				};
				
			Polymer.dom(map).appendChild(marker);
			this.setMarkerListeners(marker.id, onClick, onDragEnd);
			this.updateMarker(marker);

		},
		updateMarker: function(marker){
			console.log(marker);
			var target = this.getElem(this.ctrls.targetMarker);
			var targetObj = {};
			var icon = marker.icon;
			var obj = {};

			if(icon === null){
				if(icon.search("txt")>0){
					obj.type = "txt";
				}else if(icon.search("img")>0){
					obj.type = "img";
				}else if(icon.search("vid")>0){
					obj.type = "vid";
				}
			}
			targetObj.longitude = target.longitude;
			targetObj.latitude = target.latitude;
			this.geoji.target = targetObj;
			obj.private = this.private;
			obj.latitude = marker.latitude;
			obj.longitude = marker.longitude;
			this.geoji[marker.id] = obj;
		},
		pixelOffsetToLatLng: function(offsetx, offsety) {
		  var map = document.querySelector('google-map').map;
		  var latlng = map.getCenter();
		  var scale = Math.pow(2, map.getZoom());
		  var nw = new google.maps.LatLng(
		      map.getBounds().getNorthEast().lat(),
		      map.getBounds().getSouthWest().lng()
		  );

		  var worldCoordinateCenter = map.getProjection().fromLatLngToPoint(latlng);
		  var pixelOffset = new google.maps.Point((offsetx/scale) || 0,(offsety/scale) ||0);

		  var worldCoordinateNewCenter = new google.maps.Point(
		      worldCoordinateCenter.x - pixelOffset.x,
		      worldCoordinateCenter.y + pixelOffset.y
		  );

		  var latLngPosition = map.getProjection().fromPointToLatLng(worldCoordinateNewCenter);

		  return latLngPosition;
		},
		_getCurrentLocation: function(){
			console.log("getting current location.");
		},
		_setTitle: function(){
			var title = this.getElem(this.ctrls.title);

			if(title !== null){
				this.geoji.title = title.value;
			}
		},
		_setPrivate: function(){
			var pToggle = this.getElem(this.ctrls.public);

			if(pToggle !== null){
				this.geoji.private = pToggle.checked;
				this.getElem(this.ctrls.email).hidden = !pToggle.checked;
			}
		}

	});
</script>
