<!-- 
This is an element button used as a base for other buttons.
 text = The text to be displayed on the button
 icon = The icon to be desplayed on the button
 iput = This is the id of the component the button will call a method on.

 style of the button is set via j-styles behavior.
 interaction is set via j-handler.
 if the button doesn't have an explicit id, one is assigned via auto-id.
-->
<!-- components: -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/j-ui/j-button.html">
<link rel="import" href="../../elements/j-ui/j-profile-img.html">
<link rel="import" href="../../elements/j-ui/j-dialog.html">
<link rel="import" href="../../elements/api/imgur-upload.html">
<!-- behaviors: -->
<link rel="import" href="../../behaviors/style/j-styles.html">
<link rel="import" href="../../behaviors/interaction/j-handler.html">
<link rel="import" href="../../behaviors/interaction/j-events.html">
<link rel="import" href="../../behaviors/selection/auto-id.html">
<link rel="import" href="../../behaviors/style/j-styles.html">
<link rel="import" href="../../behaviors/util/j-util.html">

<style>

	paper-card.collection{
		--paper-card-background-color: white;
		--paper-card-background-size: cover;
		width: 50vw;
	    height: 50%;
	    padding: 1%;
        left: 15%;
	}
	

</style>	

<dom-module id= "geoji-feed">
	<template>

		<firebase-collection
	    	id= "{{assignCtrl('geojiMine')}}"
			limit-to-first="100"
		    location="{{mineURL}}"
		    data="{{mineFeed}}">
		</firebase-collection>

	    <firebase-collection
	    	id= "{{assignCtrl('feed')}}"
			limit-to-first="100"
			location="{{feedURL}}"
		    data="{{mainFeed}}">
		</firebase-collection>

	    <firebase-collection
	    	id= "{{assignCtrl('geojiPublic')}}"
			limit-to-first="100"
		    location="{{publicURL}}"
		    data="{{publicFeed}}">
		</firebase-collection>

		<firebase-collection
	    	id= "{{assignCtrl('geojiPrivate')}}"
			limit-to-first="100"
		    location="{{privateURL}}"
		    data="{{privateFeed}}">
		</firebase-collection>


		<template is="dom-repeat" items="{{publicFeed}}" as="public">
			<div name="[[_computeData(public)]]" hidden="true"></div>
		</template>

		<template is="dom-repeat" items="{{privateFeed}}" as="private">
			<div name="[[_computeData(private)]]" hidden="true"></div>
		</template>

		<template is="dom-repeat" items="{{mineFeed}}" as="mine">
			<!-- <div name="[[_computeMine(mine)]]" hidden="true"></div> -->
		</template>
		

		<template id="feedList" is="dom-repeat" items="{{mainFeed}}" as="data">

		    <paper-card id="[[assignCtrl(data.id)]]_feedCard" heading="[[_computeTitle(data)]]" image="[[_computeImg(data)]]" class="collection center">
				<div class="card-content">
					<!-- <template is="dom-repeat" items="[[_computeData(data)]]" as="item"></template> -->
				</div>
		      	<div class="card-actions">
		      	  	<template  is="dom-if" if="{{canShare}}"><paper-button id"{{assignCtrl('Share')}}">Share</paper-button></template>  
				  	<a id="{{assignCtrl('exploreLink')}}" href="{{baseUrl}}/geoji/{{data.id}}"><paper-button id"{{assignCtrl('Edit')}}" on-tap="exploreHandler" name="{{data.id}}exploreBtn">Explore</paper-button></a>
				  	<paper-button id"{{assignCtrl('Keep')}}">Keep</paper-button>
		      	</div>
		    </paper-card>
		</template>

		<!-- <paper-dialog id="{{assignCtrl('cipherDialog')}}" modal role="alertdialog">
			<h2>Enter Cipher</h2>
			<input id="{{assignCtrl('cipherInput')}}" is="iron-input" bind-value="">
			<paper-progress class="bar" id="{{assignCtrl('encryptProgress')}}"></paper-progress>
			<paper-spinner-lite id="{{assignCtrl('decryptSpinner')}}"  class="center"></paper-spinner-lite>
		</paper-dialog> -->

	</template>
</dom-module>

<script>
	// I pass the button handler property from the base element, defined as the input
	// The call back is made via document.querySelector on the input element name.
	Polymer({		
		is: "geoji-feed",
		properties: {
			cardImg: {
				type: String,
				value: ""
			},
			heading: {
				type: String,
				value: "GEOJI"
			},
			detail: {
				type: String,
				value: ""
			},
			description: {
				type: String,
				value: ""
			},
			canShare: {
				type: Boolean,
				value: true
			},
			feedURL: {
		        type: String
	      	},
	      	mineURL: {
		        type: String
	      	},
	      	privateURL: {
		        type: String
	      	},
			publicURL: {
		        type: String
	      	},
	      	privateURL: {
		        type: String
	      	},
	      	mineFeed: {
	      		type: Array,
	      		value: []
	      	},
	      	publicFeed: {
	      		type: Array,
	      		value: []
	      	},
	      	privateFeed: {
	      		type: Array,
	      		value: []
	      	},
	      	mainFeed: {
	      		type: Array,
	      		value: []
	      	},
	      	currentLongitude: {
				type: String,
				observer: "_locationChange",
				notify: true
			},
			currentLatitude: {
				type: String,
				observer: "_locationChange",
				notify: true
			},
			feedReady: {
				type: Boolean,
				value: false
			}
		},

		behaviors:[StyleBehaviors.JStyles, InteractionBehaviors.JHandler, SelectionBehaviors.AutoId,
		 StyleBehaviors.jStyles, InteractionBehaviors.JEvents, UtilityBehaviors.JUtil],

		ready: function(){
			this.feedReady = true;
		},
		attached: function(){
			var self = this;

			this.uid = app.data.uid;

			setTimeout(function(){
				var feed = self.getElem(self.ctrls.feed);
				var location = self.getElem("geoLocation");

		        self.currentLongitude = location.longitude;
		        self.currentLatitude = location.latitude;
		        
		    }, 2000);

		    this._updateLocation();

		},
		exploreHandler: function(e){
			var self = this;
			var map = this.getElem("mainMap");
			var id = e.target.name.replace("exploreBtn", "");
			
			map.loadGeoji(id);
		},
		refresh: function(){
			this.$.feedList.render();
		},
		clearFeed: function(){
			var feed = this.getElem(this.ctrls.feed);
			feed.location = "https://geoji.firebaseio.com/feed/";
			feed.removeByKey(app.data.uid);
			feed.location = "https://geoji.firebaseio.com/feed/"+app.data.uid;
			
		},
		_computeData: function(data){
			var self = this;
			setTimeout(function(){
				var feed = self.getElem(self.ctrls.feed);
				var feedList = self.getElem("feedList");
				var arr = [];
				var lookup = {};

				for (i in self.mainFeed) {
				    lookup[self.mainFeed[i].id] = self.mainFeed[i];
				}

				if(!data.encrypted){

					if(self._inRange(data)){
						if(lookup[data.id] === null || lookup[data.id] === undefined){
							if(self._computeMine(data)){
								feed.add(data);
								self.$.feedList.render()
							}else{
								feed.removeByKey(data.__firbaseKey__);
								self.$.feedList.render()
							}
						}
					}
				}
		    }, 2000);

		},
		_computeMine: function(data){
			var self = this;
			var lookup = {};

			for (i in this.mineFeed) {
				lookup[this.mineFeed[i].id] = this.mineFeed[i];
			}

			if(lookup[data.id] === null || lookup[data.id] === undefined){
				return true;
			}else{
				return false;
			}

		},
		_inRange: function(data){
			var self = this;
			var feed = this.getElem(this.ctrls.feed);
			var feedList = this.getElem(this.ctrls.feedList);
			var location = this.getElem("geoLocation");
			var target = data.target;
			var dist = this.geoDistance(target.latitude, target.longitude, location.latitude, location.longitude, "M");
			var postDec = dist.toString().split(".");
			var chars = postDec[1].split("");
			var places = [];

			for(char in chars){
				if(parseFloat(chars[char])!==0){
					break;	
				}
				places.push(chars[char]);
			}

			if(places.length>=2){
				return true;
			}else{
				return false;
			}

		},
		_computeTitle: function(data){

			if(data.title !== null && data.title !== undefined){
				return data.title;
			}else{
				return "GEOJI";
			}
	
		},
		_computeImg: function(data){

			if(data.coverImg !== null && data.coverImg !== undefined){
				return data.coverImg;
			}else{
				if(data.encrypted === false || data.encrypted === null || data.encrypted === undefined){
					return "/images/mascot-default.png";
				}else if(data.encrypted){
					return "/images/mascot-encrypted.png";
				}
			}
		},
		_locationChange: function(){
			var self = this;
			var publicDB = this.getElem(this.ctrls.geojiPublic);
			var privateDB = this.getElem(this.ctrls.geojiPrivate);

		},
		_updateLocation: function(){
			var self = this;
			var publicDB = this.getElem(this.ctrls.geojiPublic);
			var privateDB = this.getElem(this.ctrls.geojiPrivate);
			var feed = this.getElem(this.ctrls.feed);
			var feedList = this.getElem("feedList");
			var location = this.getElem("geoLocation");

			setInterval(function(){
				var feed = self.getElem(self.ctrls.feed);
				var location = self.getElem("geoLocation");

		    	self.currentLongitude = location.longitude;
		    	self.currentLatitude = location.latitude;


		    	for(i in self.publicFeed){
		    		for(j in self.mainFeed){
		    			if(self.publicFeed[i].id === self.mainFeed[j].id){
		    				if(!self._inRange(self.publicFeed[i])){
		    					feed.remove(self.publicFeed[i]);
		    					feedList.render();
		    				}else if(self._inRange(self.publicFeed[i])){
		    					self._computeData(self.publicFeed[i]);
		    				}
		    			}
		    		}

		    	}
		    	for(i in self.privateFeed){
		    		for(j in self.mainFeed){
		    			if(self.privateFeed[i].id === self.mainFeed[j].id){
		    				if(!self._inRange(self.privateFeed[i])){
		    					feed.remove(self.privateFeed[i]);
		    					feedList.render();
		    				}else if(self._inRange(self.privateFeed[i])){
		    					self._computeData(self.privateFeed[i]);
		    				}
		    			}
		    		}

		    	}
		    }, 3000);
		}

	});
</script>
